## BOLT #05-オンチェーントランザクションの推奨事項

### 概要

Lightningでは、ローカルノードとリモートノードが、チャネルの現在の状態（基本的には現在の残高）を記述する相互署名されたコミットメントトランザクションを送り合うことで、オフチェーンでトランザクションを実行できます。  
このコミットメントトランザクションは、新しい支払いが行われるたびに更新され、 いつでも引き出すことが可能です。  

チャネルを終了させるためにはコミットメントトランザクションをブロックチェーンに展開するのですが、これには3つの方法があります。  

1. mutualクローズ  
ローカルノードとリモートノードがチャネルを閉じることに合意して、クローズトランザクションをブロックチェーンに展開します。([BOLT#2: チャネルクローズ]())  

2. unilateralクローズ  
リモートノードがクラッシュする等、何らかの異常でリモートノードと通信ができない場合に、最新のコミットメントトランザクションを展開します。

3. revoked transactionクローズ  
一方のノードが、自らの支払いをなかったことにしたいというような悪意から、故意に古いコミットメントトランザクションを展開します。  

Lightningは相手ノードを信頼することなしに使うことを前提に設計されているので、上記3通りのクローズについて適切に処理が行われる限り資金を失うリスクはありません。  
本章では、ノードが上記のケースに際してどのように応答するべきかを説明します。  

## 目次

- [コミットメントトランザクション](#コミットメントトランザクション)  
- [チャネルの失敗](#チャネルの失敗)
- [Mutualクローズ](#Mutualクローズ)
- [Unilateralクローズ](#Unilateralクローズ)
    - [ローカルコミットメントトランザクション](#Unilateralクローズ:ローカルコミットメントトランザクション)
        - [HTLC:ローカルコミットメントとローカルオファー](#HTLC:ローカルコミットメントとローカルオファー)
        - [HTLC:ローカルコミットメントとリモートオファー](#HTLC:ローカルコミットメントとリモートオファー)
    - [リモートコミットメントトランザクション](#Unilateralクローズ:リモートコミットメントトランザクション)
        - [HTLC:リモートコミットメントとローカルオファー](#HTLC:ローカルコミットメントとローカルオファー)
        - [HTLC:リモートコミットメントとリモートオファー](#HTLC:ローカルコミットメントとリモートオファー)
- [Revokedトランザクション](#Revokedトランザクション)


## コミットメントトランザクション

ローカルノードとリモートノードはそれぞれコミットメントトランザクションを保持しています。  
このトランザクションには4つの種類があります。  

1. ローカルノードのメイン出力: ローカルノードのコミットメント公開鍵へ支払う出力が0もしくは1つ  

2. リモートノードのメイン出力: リモートノードのコミットメント公開鍵へ支払う出力が0もしくは1つ  

3. ローカルノードが提供するHTLCs: 支払いプレイメージと引き換えにリモートノードへ支払う出力が0もしくはそれ以上の保留中の支払い(HTLCs)  

4. リモートノードが提供するHTLCs: 支払いプレイメージと引き換えにローカルノードへ支払う出力が0もしくはそれ以上の保留中の支払い(HTLCs)  

ローカルノードとリモートノードの協力を促すために、`OP_CHECKSEQUENCEVERIFY`(相対タイムアウト)がそれぞれの出力(それぞれが持つコミットメントトランザクション)を管理しています。  
例えば、ローカルノードが自身の持つコミットメントトランザクションを発行した時、リモートノードは自身の資金に直ちにアクセスできるのに対し、ローカルノードは自身の資金へのアクセスを待つ必要があります。  

[BOLT#3: コミットメントトランザクション]()でより詳細な情報を確認できます。  

## チャネルの失敗

様々な方法でチャネルを閉じることができますが、最も効率的な方法が推奨されます。  
また、エラーが発生した場合には、チャネルを閉じる必要があります。  
相手にエラーメッセージを送信するための要件は、[BOLT#1: エラーメッセージ(`error`)](#エラーメッセージ(`error`))で定義されています。

### 必要要件

- ローカルのコミットメントトランザクションに`to_local`もしくはHTLCが一度も含まれていなかった場合、チャネルを忘れてしまうことがあります。  
- 過去に含まれていたが、現在のコミットメントトランザクションに`to_local`もしくはHTLCが含まれていない場合、リモートノードがチャネルをクローズすることを待ちます。また、リモートノードがクローズするまではチャネルを忘れてはいけません。  
- 現在のコミットメントトランザクションにも上記のいずれかが含まれていて、手数料分を含んだ有効な`closing_signed`メッセージを受信した場合、この手数料を使用して**mutualクローズ**を実行します。  
- `closing_signed`メッセージが受信できない場合、署名を持っている最後のコミットメントトランザクションを使用して**unilateralクローズ**を実行しなければいけません。  

## Mutualクローズ

クローズトランザクションはファンディングトランザクションの出力を処理します。  
Mutualクローズでは、指定された`scriptpubkey`に送信される出力に既に同意しているためノードは何もする必要がありません。(参照: [BOLT#2: クロージング](#シャットダウン))

## Unilateralクローズ
### ローカルコミットメントトランザクション

Unilateralクローズには2種類のケースがあり、こちらではノードがローカルにファンディングトランザクションの出力を処理するコミットメントトランザクションを発見した場合について説明します。  

注意点として、unirateralクローズでクローズした出力から、ノードは直ぐに資金を取得することができません。  
リモートノードの`to_self_delay`にて指定された`OP_CHECKSEQUENCEVERIFY`が経過した後、ノードは資金を取得することができます。  

#### 必要要件

ローカルコミットメントトランザクションを発見した際、

- `to_local`の出力を適当なアドレスに支払います。
- `to_self_delay`にて指定された`OP_CHECKSEQUENCEVERIFY`が経過した後、支払われた出力を使用できます。
- `to_remote`の出力は考慮しなくても良いです。リモートノードから見るとコミットメントトランザクションによって処理されたと見なされるため、ローカルノードからの何かしらのアクションは不要です。
- それぞれのHTLCを処理しなければいけません。(参考: [HTLC:ローカルコミットメントとローカルオファー](#HTLC:ローカルコミットメントとローカルオファー)、[HTLC:ローカルコミットメントとリモートオファー](#HTLC:ローカルコミットメントとリモートオファー))

#### HTLC:ローカルコミットメントとローカルオファー

HTLCは、タイムアウト後にローカルオファーとしてHTLCタイムアウトトランザクションを使用する、もしくは支払いのプレイメージを持つリモートノードによって、使用されます。  

HTLCの中には、ダストとして削減されたり、部分的にコミットされたりするような出力のために確認できないHTLCもあります。  

HTLCはHTLCの`cltv_expiry`以上にブロックが積み重なった場合にはタイムアウトします。

##### 必要要件

- コミットメントトランザクションのHTLCが支払いのプレイメージによって使用される場合、この出力は取り消しできないほど処理したと見なされます。  
この時、トランザクションの入力witnessからプレイメージを抽出しなければいけません。
- コミットメントトランザクションのHTLCがタイムアウトして、まだ処理されていない場合  
    - HTLCタイムアウトトランザクションを使用して、出力を処理しなければいけません。  
    - 処理しているトランザクションが適切なブロックの深さに達した時  
        - 新たに送信されてくるHTLCは失敗させなければいけません。  
        - HTLCタイムアウトトランザクションの出力を処理しなければいけません。  
        - HTLCタイムアウトトランザクションの出力は適当なアドレスに送信される必要があります。  
        この出力が使用される場合は、上記の通り処理された時は支払いのトランザクションで処理されますが、そうでない時はHTLCタイムアウトトランザクションによって処理されます。  
        - リモートノードの`open_channel`の`to_self_delay`にて指定された`OP_CHECKSEQUENCEVERIFY`が経過しなければ、HTLCタイムアウト出力は使用できません。  
- コミットメントトランザクションで出力を持たないコミットされたHTLCの場合
    - コミットメントトランザクションが適切なブロックの深さに達した時、新たに送信されてくるHTLCは失敗させなければいけません。  
    - コミットメントトランザクションにHTLCに対応する出力が含まれていない時、新たに送信されてくるHTLCはより早く失敗させなければいけません。  

#### HTLC:ローカルコミットメントとリモートオファー

HTLCは、支払いのプレイメージを持っていてそれを使用することのできる受信者のみがHTLC-successトランザクションを使用することで処理できます。  
このプレイメージを持っていない場合は、オファーする側の責任においてタイムアウトになった後のHTLCを使用します。

HTLCの処理には以下の3種類のケースがあります。  

1. オファーする側が取り消せないようなコミットをすることはありません。  
完全にコミットされるまでHTLCを転送しないために、受信者はプレイメージを知ることは通常ありません。  
従って、プレイメージを使用した受信者が最終ホップのであることがわかり、この時はHTLCのタイムアウトを許可することが最善となります。  
2. オファーする側はオファーされたHTLCに対して取り消しできないコミットをしますが、受信者は送信されたHTLCをコミットすることができません。  
この時は、受信者は送信されたHTLCを転送したりタイムアウトすることができます。  
3. 受信者はオファーされたHTLCと引き換えに、送信されたHTLCにコミットします。  
この時、受信者は送信されたHTLCから受信したプレイメージを使用しなければなりません。  
そうしなければ自身への入金分を引き出さずに出金を送信することで資金が失われます。

##### 必要要件

ローカルノードについて  

- オファーされた未処理のHTLCおよびコミット済みの送信するHTLCの支払いプレイメージを受信した場合  
    - HTLC-successトランザクションを使用して、支払いの出力を処理しなければいけません。  
    - HTLC-successトランザクションの出力を処理しなければいけません。  
- リモートノードが取り消せないほどのHTLCをコミットしていない場合は出力の処理を行ってはいけません。  
- HTLC-successトランザクションの出力を適当なアドレスへ送信します。  
- リモートノードの`open_channel`の`to_self_delay`にて指定された`OP_CHECKSEQUENCEVERIFY`が経過しなければ、HTLC-successトランザクションの出力は使用できません。

この出力が使用される場合は、上記の通り処理された時は支払いのトランザクションで処理されますが、そうでない時はHTLC-successトランザクションによって処理されたと見なされます。  

### リモートコミットメントトランザクション

リモートノードのコミットメントトランザクションはファンディングトランザクションの出力を処理します。  
この場合は、ノードの動作を制限する待機時間はなく、ノードが[前項](#Unilateralクローズ:ローカルコミットメントトランザクション)のようにローカルコミットメントトランザクションを見つけて処理する場合よりも簡単です。

#### 必要事項

ローカルノードについて

- リモートノードが展開した有効なコミットメントトランザクションを見つけた場合
    - このトランザクションに紐付く`to_remote`(ローカルノードへのP2WPKH出力)、`to_local`(リモートノードへの支払いの出力)に関する処理は行われない場合もあります。  
    これらはコミットメントトランザクションによって処理されたと見なされます。  
    - それぞれのHTLCを処理しなければいけません。(参考: [HTLC:リモートコミットメントとローカルオファー](#HTLC:ローカルコミットメントとローカルオファー)、[HTLC:リモートコミットメントとリモートオファー](#HTLC:ローカルコミットメントとリモートオファー))

#### HTLC:リモートコミットメントとローカルオファー

HTLCはタイムアウトした後にそれぞれのローカルオファーによって使用されるか、支払いプレイメージを持っている場合にリモートの受信者がHTLC-successトランザクションを用いることで使用されます。  
HTLCの中には、ダストとして削減されたり、リモートノードが異なるHTLCを持つ2つの有効なコミットメントトランザクションがあるために確認できないHTLCもあります。  

HTLCはHTLCの`cltv_expiry`以上にブロックが積み重なった場合にはタイムアウトします。

#####  必要事項

ローカルノードについて

- 支払いプレイメージを使用してコミットメントトランザクションのHTLCを使用する場合、この出力は取り消しできないほど処理したと見なされます。  
この時TLC-successトランザクションの入力witnessからプレイメージを抽出しなければいけません。
- コミットメントトランザクションのHTLCがタイムアウトして、まだ処理されていない場合  
    - 適当なアドレスに支払いを行うことで出力を処理しなければいけません。  
- コミットメントトランザクションで出力を持たないコミットされたHTLCの場合  
    - コミットメントトランザクションが適切なブロックの深さに達した時、新たに送信されてくるHTLCは失敗させなければいけません。  
    - コミットメントトランザクションにHTLCに対応する出力が含まれていない時、新たに送信されてくるHTLCはより早く失敗させなければいけません。 

#### HTLC:リモートコミットメントとリモートオファー

リモートのHTLCはローカルノードがプレイメージを持っている時のみ使用することができます。  
ローカルノードがこのプレイメージを持っていない場合は、リモートノードの責任においてタイムアウトになった後のHTLCを使用します。

HTLCの処理には以下の3種類のケースがあります。  

1. オファーする側が取り消せないようなコミットをすることはありません。  
完全にコミットされるまでHTLCを転送しないために、受信者はプレイメージを知ることは通常ありません。  
従って、プレイメージを使用した受信者が最終ホップのであることがわかり、この時はHTLCのタイムアウトを許可することが最善となります。  
2. オファーする側はオファーされたHTLCに対して取り消しできないコミットをしますが、受信者は送信されたHTLCをコミットすることができません。  
この時は、受信者は送信されたHTLCを転送したりタイムアウトすることができます。  
3. 受信者はオファーされたHTLCと引き換えに、送信されたHTLCにコミットします。  
この時、受信者は送信されたHTLCから受信したプレイメージを使用しなければなりません。  
そうしなければ自身への入金分を引き出さずに出金を送信することで資金が失われます。  

##### 必要要件

ローカルノードについて

- オファーされた未処理のHTLCから支払いプレイメージを受信し、送信するHTLCにコミットしている場合、適当なアドレスに出力を処理しなければいけません。  
- リモートノードが取り消せないほどのHTLCをコミットしていない場合は出力の処理を行ってはいけません。  

## Revokedトランザクション

期限切れのコミットメントトランザクション(最新でない、古いコミットメントトランザクション)を展開して不正を行おうとするノードがある場合、チャネル内の他のノードは秘密鍵を使用して、チャネルの元のファンディングトランザクションからすべての資金を請求できます。  

###必要要件

